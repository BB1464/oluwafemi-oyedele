{
  "hash": "2615de020131edd1879bd82f4a49862c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Interaction bar plots with standard error and lettering in R'\ndate: '2024-06-02'\ncategories: ['123', 'Second Tag']\ndescription: 'Interraction bar plot in R'\nexecute:\n  message: false\n  warning: false\neditor_options: \n  chunk_output_type: console\nformat:\n  html:\n    comments:\n      utterances:\n         repo: BB1464/oluwafemi-oyedele\n---\n\n\n# Introduction\nIn this blog post, we will go through the steps of quickly creating multiple bar plots with standard error and lettering using R. We will perform an Analysis of Variance (ANOVA) and a Least Significant Difference (LSD) test to understand the effects of different nitrogen (N) rates on rice. Finally, we will create visualizations to present the results. Let’s dive in!\n\n# Load Necessary Libraries\nWe begin by loading the required libraries. These libraries will help us with data manipulation, statistical analysis, and visualization.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(agricolae)\nlibrary(reshape2)\nlibrary(readxl)\n```\n:::\n\n\n# Import the Data Set\nNext, we import the dataset from an Excel file named “data_rice.xlsx”. We display the first few rows and the column names to understand the structure of the data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- read_excel(path = \"data/data_rice.xlsx\", col_names = TRUE)\n\nhead(df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n    rep Nrate             Heading Maturity Yield\n  <dbl> <chr>               <dbl>    <dbl> <dbl>\n1     1 Control (No Urea)    54.2     26.5  2.88\n2     2 Control (No Urea)    78.3     27.0  3.03\n3     3 Control (No Urea)    72.7     26.7  2.76\n4     1 Urea 25 kg/ha        72.5     36.6  3.48\n5     2 Urea 25 kg/ha        84.3     32.1  3.17\n6     3 Urea 25 kg/ha        75.3     34.8  2.93\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"rep\"      \"Nrate\"    \"Heading\"  \"Maturity\" \"Yield\"   \n```\n\n\n:::\n:::\n\n\n# Convert Variables to Factors\nWe convert the columns rep and Nrate to factors because they represent categorical variables in our analysis. I will make use of the across function from dplyr\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df %>% \n  mutate(across(.cols=c(1:2),.fns=factor))\n```\n:::\n\n\n# View the new structure of the data\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntibble [15 × 5] (S3: tbl_df/tbl/data.frame)\n $ rep     : Factor w/ 3 levels \"1\",\"2\",\"3\": 1 2 3 1 2 3 1 2 3 1 ...\n $ Nrate   : Factor w/ 5 levels \"Control (No Urea)\",..: 1 1 1 3 3 3 4 4 4 5 ...\n $ Heading : num [1:15] 54.2 78.3 72.7 72.5 84.3 ...\n $ Maturity: num [1:15] 26.5 27 26.7 36.6 32.1 ...\n $ Yield   : num [1:15] 2.88 3.03 2.76 3.48 3.17 ...\n```\n\n\n:::\n:::\n\n\n# Define Response Variables\nWe define response_vars as all columns from the third to the last column in the dataset. These columns represent different growth and yield characteristics.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse_vars <- colnames(df)[3:ncol(df)]\n```\n:::\n\n\n# Analysis of Variance (ANOVA)\nWe are performing ANOVA (Analysis of Variance) for multiple response variables stored in a list called response_vars. We first initialize an empty list called anova_result to store the ANOVA results for each response variable. The code then iterates over each response variable in response_vars. If a response variable contains a space in its name, it is wrapped in backticks to ensure it is correctly interpreted within the formula.\n\nA formula is then dynamically constructed for each response variable, where the response variable is modeled as a function of two factors: “rep” and “Nrate”. This formula is passed to the aov function, which performs the ANOVA using the data frame df. The resulting ANOVA object is stored in the anova_result list, with the response variable name as the key. For each response variable, the code prints a message indicating that ANOVA is being performed, followed by the summary of the ANOVA results. This process allows us to systematically conduct and review ANOVA for multiple response variables in a dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova_result <- list()\n\nfor (i in response_vars) {\n  if(grepl(\" \", i)) {\n    i <- paste0(\"`\", i, \"`\")\n  }\n  formula <- as.formula(paste(i, \"~\", \"rep\", \"+\", \"Nrate\"))\n  anova_result[[i]] <- aov(formula, data = df)\n  \n  print(paste(\"ANOVA for\", i))\n  print(summary(anova_result[[i]]))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"ANOVA for Heading\"\n            Df Sum Sq Mean Sq F value Pr(>F)  \nrep          2  345.8  172.88   3.147 0.0981 .\nNrate        4 1211.6  302.90   5.514 0.0198 *\nResiduals    8  439.5   54.94                 \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n[1] \"ANOVA for Maturity\"\n            Df Sum Sq Mean Sq F value  Pr(>F)   \nrep          2   26.2   13.08   1.456 0.28879   \nNrate        4  507.3  126.82  14.126 0.00107 **\nResiduals    8   71.8    8.98                   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n[1] \"ANOVA for Yield\"\n            Df Sum Sq Mean Sq F value  Pr(>F)   \nrep          2  0.160  0.0802   0.377 0.69737   \nNrate        4  7.487  1.8716   8.801 0.00501 **\nResiduals    8  1.701  0.2127                   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n# Least Significant Difference (LSD) Test\n\nThen we conducted post-hoc analysis using the Least Significant Difference (LSD) test for multiple response variables stored in response_vars. We first initialize an empty list called lsd_result to store the LSD test results for each response variable. The code iterates over each response variable in response_vars, and if a variable’s name contains a space, it is enclosed in backticks to ensure it is correctly processed. For each response variable, the LSD test is performed using the corresponding ANOVA result from the previously stored anova_result list, focusing on the treatment factor “Nrate” with a significance level (alpha) of 0.05. The test results, including means and groups, are then merged into a single data frame.\n\nThe standard error (SE) for each response variable is calculated by dividing the standard deviation by the square root of the number of replicates. The resulting data frame is stored in the lsd_result list, with each data frame’s column containing the response variable values, means, groups, and standard errors. The column name for the response variable is standardized to “response”. Finally, the results for each response variable are printed. This process ensures a detailed post-hoc analysis following ANOVA, allowing for a clear comparison of treatment means.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlsd_result <- list()\nfor (i in response_vars) {\n  if(grepl(\" \", i)) {\n    i <- paste0(\"`\", i, \"`\")\n  }\n  lsd_result[[i]] <- LSD.test(anova_result[[i]], trt = \"Nrate\", alpha = 0.05)\n  lsd_result[[i]] <- merge(x = lsd_result[[i]]$means[1:3], y = lsd_result[[i]]$groups[2], by.x = \"row.names\", by.y = \"row.names\", all.x = FALSE)\n  lsd_result[[i]]$SE <- lsd_result[[i]]$std / sqrt(lsd_result[[i]]$r)\n  lsd_result[[i]] <- data.frame(lsd_result[[i]])\n  colnames(lsd_result[[i]])[2] <- \"response\"\n  print(lsd_result[[i]])\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          Row.names response       std r groups       SE\n1 Control (No Urea) 68.44509 12.609047 3      c 7.279837\n2    Urea 100 kg/ha 87.97074  5.763612 3     ab 3.327623\n3     Urea 25 kg/ha 77.39595  6.182959 3     bc 3.569733\n4     Urea 50 kg/ha 80.05120  4.757606 3     bc 2.746805\n5     Urea 75 kg/ha 94.64645 11.813072 3      a 6.820281\n          Row.names response       std r groups        SE\n1 Control (No Urea) 26.74720 0.2452797 3      d 0.1416123\n2    Urea 100 kg/ha 39.30555 3.5689391 3     ab 2.0605280\n3     Urea 25 kg/ha 34.49546 2.2648864 3     bc 1.3076328\n4     Urea 50 kg/ha 33.48755 5.2644154 3      c 3.0394116\n5     Urea 75 kg/ha 44.04475 1.8292321 3      a 1.0561076\n          Row.names response       std r groups         SE\n1 Control (No Urea) 2.890565 0.1376631 3      b 0.07947983\n2    Urea 100 kg/ha 2.710516 0.3322514 3      b 0.19182546\n3     Urea 25 kg/ha 3.191620 0.2721221 3      b 0.15710978\n4     Urea 50 kg/ha 2.861858 0.7981537 3      b 0.46081427\n5     Urea 75 kg/ha 4.636202 0.3007376 3      a 0.17363091\n```\n\n\n:::\n:::\n\n\n# Prepare Data for Plotting\nNext, we are combining the results of the LSD tests for multiple response variables into a single data frame for further analysis or visualization. First, we use do.call() to merge all individual data frames stored in lsd_result into one large data frame called combined_df. We then add a new column, variables, to combined_df to store the row names, which represent the response variable names. The original row names are subsequently removed using rownames(combined_df) <- NULL. The first column of combined_df is renamed to “Nrate” to reflect the treatment levels.\n\nNext, we clean up the variables column by removing any characters following a period (.) using sub() function, which simplifies the variable names. Additionally, backticks are removed from the variable names using gsub() function.\n\nFinally, the Nrate column is converted to a factor with specific levels to ensure that the treatment levels are ordered meaningfully: “Control (No Urea)”, “Urea 25 kg/ha”, “Urea 50 kg/ha”, “Urea 75 kg/ha”, and “Urea 100 kg/ha”. This transformation facilitates easier plotting and interpretation of the results. The resulting combined_df contains the LSD test results for all response variables, with standardized treatment levels and cleaned variable names, ready for further analysis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncombined_df <- do.call(rbind, lsd_result)\ncombined_df$variables <- rownames(combined_df)\nrownames(combined_df) <- NULL\ncolnames(combined_df)[1] <- \"Nrate\"\ncombined_df$variables <- sub(\"\\\\..*\", \"\", combined_df$variables)\ncombined_df$variables <- gsub(\"`\", \"\", combined_df$variables)\ncombined_df$Nrate <- factor(combined_df$Nrate, levels = c(\n  \"Control (No Urea)\",\n  \"Urea 25 kg/ha\",\n  \"Urea 50 kg/ha\",\n  \"Urea 75 kg/ha\",\n  \"Urea 100 kg/ha\"\n))\n```\n:::\n\n\n# Create the Bar Plot\n\nNext, we created a detailed and customized bar plot using the ggplot2 package to visualize the results of the LSD tests for different response variables. The code plots the combined_df data frame, specifically the rows where variables match the names in response_vars.\n\nSetting up the plot: The ggplot function initializes the plot with the data filtered to include only the relevant response variables. The aes function sets up the aesthetic mappings, specifying Nrate on the x-axis, response on the y-axis, and filling the bars based on Nrate.\nAdding bars: The geom_bar function creates bar plots with the specified aesthetics, drawing bars with black borders and setting their position to dodge each other for clarity. The width of the bars is set to 0.9.\nAdding error bars: The geom_errorbar function adds error bars to each bar, representing the standard error (SE). The error bars are positioned to align with the bars and have a width of 0.10.\nAdding text labels: The geom_text function adds text labels above each bar, displaying the group labels. The labels are positioned slightly above the error bars for better visibility.\nCustomizing labels and theme: The labs function sets empty titles and labels for the x-axis and fill legend, while the y-axis label is set to “Growth and yield characteristics”. The theme function customizes the axis text to rotate the x-axis labels by 45 degrees for better readability and sets other aesthetic elements like legend position, strip placement, and panel spacing.\nFaceting: The facet_wrap function splits the plot into multiple panels, one for each response variable. Each panel has its own y-axis scale and is arranged in a single column.\nFurther customization: The plot’s theme is further customized to remove major and minor grid lines, set the panel background to blank, and ensure the axis lines are clearly visible. The scale_y_continuous function ensures the y-axis scales appropriately with a slight expansion for better spacing.\nCustomizing fill colors: The scale_fill_manual function applies a specific color palette from the ggsci package, using the “Journal of Clinical Oncology” (JCO) color palette for the bars.\nThis comprehensive code creates a clear, well-labeled, and aesthetically pleasing visualization of the LSD test results, making it easy to compare the effects of different Nrate treatments on various response variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot <- ggplot(combined_df[combined_df$variables %in% response_vars, ],\n                aes(x = factor(Nrate),\n                    y = response,\n                    fill = factor(Nrate))) +\n  geom_bar(stat = \"identity\",\n           color = \"black\",\n           position = position_dodge(width = 0.5),\n           width = 0.9) +\n  geom_errorbar(aes(ymin = response - SE,\n                    ymax = response + SE),\n                position = position_dodge(width = 0.9),\n                width = 0.10) +\n  geom_text(aes(x = Nrate,\n                y = response + SE,\n                label = as.matrix(groups)),\n            position = position_dodge(width = 0.9),\n            vjust = -0.5,\n            hjust = 0.5) +\n  labs(title = \"\",\n       x = \"\",\n       y = \"Growth and yield characteristics\",\n       fill = \"\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  facet_wrap(facets = ~variables,\n             ncol = 1,\n             scales = \"free_y\",\n             switch = \"y\") +\n  theme(legend.position = \"right\",\n        strip.placement = \"outside\",\n        strip.background = element_blank(),\n        panel.spacing = unit(1, \"lines\")) +\n  scale_y_continuous(expand = expansion(mult = c(0.2, 0.2))) +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        panel.background = element_blank(),\n        axis.line.y = element_line(color = \"black\", size = 0.5),\n        axis.line.x = element_line(color = \"black\", size = 0.5)) +\n  scale_fill_manual(values = ggsci::pal_jco()(5))\n\nplot\n```\n\n::: {.cell-output-display}\n![](interaction-plot-with-letters_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n# Customize Labels and Update Plot\n\nThen we defined a custom labeller using the as_labeller function from the ggplot2 package to create more descriptive and formatted facet labels for our plot. The custom labeller is created as a named vector that maps the original variable names to more detailed and readable labels. Specifically, the custom_labeller object associates:\n\n- “Heading” with the label “Heading~(days)”\n\n- “Maturity” with the label “Maturity~(days)”\n\n- “Yield” with the label “Yield~(t~ha^{-1})”\n\nThe label_parsed argument is used to ensure that the labels are parsed as expressions, allowing the inclusion of mathematical notation and formatting in the labels. For example, t~ha^{-1} represents tons per hectare with appropriate superscripting. These custom labels enhance the readability and presentation quality of the facet labels in the ggplot, making the plot more informative and visually appealing.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncustom_labeller <- as_labeller(c(\n  Heading = \"Heading~(days)\",\n  Maturity = \"Maturity~(days)\",\n  Yield = \"Yield~(t~ha^{-1})\"\n), label_parsed)\n```\n:::\n\n\nFinally, we customize the facet labels for better readability and update the plot accordingly. We updated the labels in facet_wrap() function to use the above modified labels. We display the updated plot using the below code.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot + facet_wrap(facets = ~variables, \n                  ncol = 1, \n                  scales = \"free_y\", \n                  switch = \"y\", \n                  labeller = custom_labeller)\n```\n\n::: {.cell-output-display}\n![](interaction-plot-with-letters_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "interaction-plot-with-letters_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}